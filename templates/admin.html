{% extends "base.html" %}

{% block content %}

<!-- Public Election Dashboard Link -->
<div class="alert alert-info">
    <strong>üìä Public Dashboard:</strong>
    <a href="/dashboard" class="btn btn-sm" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #333; border: 1px solid #ce93d8;">View Public Election Dashboard</a>
    Share this link with voters to show live results: <code>{{ request.host_url }}dashboard</code>
</div>
<div class="admin-header">
    <div class="container">
        <div class="row">
            <div class="col">
                <h2 class="mb-0">Election Administration Dashboard</h2>
                <p class="mb-0">SLGS OBU General Election</p>
                <small class="text-warning">
                    üîê Admin Token: <span id="tokenStatus">Checking...</span>
                    {% if auth_ok %}
                        <span class="badge" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: #333;">‚úì Authorized</span>
                    {% else %}
                        <span class="badge" style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333;">‚úó Unauthorized</span>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Voters</h5>
                    <h2 style="color: #ce93d8;">{{ total_voters }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Votes Cast</h5>
                    <h2 style="color: #81c784;">{{ voted_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Turnout</h5>
                    <h2 style="color: #a5d6a7;">{{ "%.1f"|format((voted_count/total_voters)*100) if total_voters > 0 else 0 }}%</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Vote Counts by Position</h5>
                </div>
                <div class="card-body">
                    {% for position in positions %}
                    <h6 class="mt-4 mb-3">{{ position.name }}</h6>
                    {% set position_total_votes = position_results[position.name].values()|sum if position_results[position.name] else 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Candidate</th>
                                    <th>Votes</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in position.candidates %}
                                <tr>
                                    <td>{{ candidate.name }}</td>
                                    <td>{{ position_results[position.name][candidate.name] if position_results[position.name] else 0 }}</td>
                                    <td>{{ "%.1f"|format((position_results[position.name][candidate.name]/position_total_votes)*100) if position_total_votes > 0 and position_results[position.name] else 0 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Administration Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="d-flex gap-2">
                                <input type="number" min="0" id="votingMinutes" class="form-control" placeholder="Minutes (optional)">
                                <button class="btn" id="openVotingBtn" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: #333; border: none;">Open Voting</button>
                                <button class="btn" id="closeVotingBtn" style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333; border: none;">Close Voting</button>
                                <div class="ms-auto align-self-center">
                                    <span id="votingStatusBadge" class="badge bg-secondary">Checking...</span>
                                    <small id="votingUntilText" class="ms-2 text-muted"></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="generateVoterIds()" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #333; border: none;">
                                Generate Voter IDs
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="exportResults()" style="background: linear-gradient(135deg, #f3e5f5, #ce93d8); color: #333; border: none;">
                                Export Results
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="refreshData()" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">
                                Refresh Data
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="resetToken()" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">
                                Reset Admin Token
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="clearAllData()" style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333; border: none;">
                                Clear All Data
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn w-100" onclick="createPositions()" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">
                                Create Positions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload Voter List</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="voterFile" class="form-label">Select CSV file with voter data:</label>
                            <input class="form-control" type="file" id="voterFile" name="file" accept=".csv">
                            <div class="form-text">
                                CSV format: MemberID, FullName, PhoneNumber (VotingToken will be auto-generated as 8-digit code)
                            </div>
                        </div>
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #333; border: none;">Upload Voters</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Registered Voters</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Member ID</th>
                                    <th>Full Name</th>
                                    <th>Voter ID</th>
                                    <th>Phone Number</th>
                                    <th>Voting Token</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for voter in voters %}
                                <tr>
                                    <td>{{ voter.member_id }}</td>
                                    <td>{{ voter.full_name }}</td>
                                    <td><code>{{ voter.voter_id }}</code></td>
                                    <td>{{ voter.phone_number }}</td>
                                    <td><code>{{ voter.voting_token }}</code></td>
                                    <td>
                                        {% if voter.has_voted %}
                                            <span class="badge" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: #333;">Voted</span>
                                        {% else %}
                                            <span class="badge" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333;">Not Voted</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not voters %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        No voters registered yet. Upload a voter list above.
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Candidate Management: grouped by position -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex align-items-center">
                    <h5 class="mb-0">Manage Candidates</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <button id="createPositionsBtn" class="btn btn-sm" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">Create Positions</button>
                        <button id="checkPositionsBtn" class="btn btn-sm" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">Check Positions</button>
                        <button id="fixDatabaseBtn" class="btn btn-sm" style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333; border: none;">Fix Database</button>
                    </div>
                    <div id="debugOutput" class="alert alert-secondary" style="display: none;">
                        <small id="debugText"></small>
                    </div>
                    <div class="accordion" id="positionsAccordion">
                        {% for pos in positions %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ pos.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ pos.id }}" aria-expanded="false" aria-controls="collapse{{ pos.id }}">
                                    {{ pos.name }}
                                    <span class="ms-2">
                                        {% if pos.voting_enabled %}
                                            <span class="badge" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: #333;">Voting Open</span>
                                        {% else %}
                                            <span class="badge" style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333;">Voting Closed</span>
                                        {% endif %}
                                    </span>
                                </button>
                            </h2>
                            <div id="collapse{{ pos.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ pos.id }}" data-bs-parent="#positionsAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex mb-2 flex-wrap gap-2">
                                        <button class="btn btn-sm btn-primary me-2 add-candidate-btn" data-pos="{{ pos.id }}">Add Candidate to {{ pos.name }}</button>
                                        <button class="btn btn-sm btn-outline-info toggle-edit-btn" id="toggleEditBtn{{ pos.id }}" data-pos="{{ pos.id }}">Edit Candidates</button>
                                        <button class="btn btn-sm btn-outline-secondary d-none refresh-pos-btn" id="refreshBtn{{ pos.id }}" data-pos="{{ pos.id }}">Refresh</button>
                                        <button class="btn btn-sm toggle-voting-btn" id="toggleVotingBtn{{ pos.id }}" data-pos="{{ pos.id }}"
                                                {% if pos.voting_enabled %}
                                                style="background: linear-gradient(135deg, #ffcdd2, #f8bbd9); color: #333; border: none;"
                                                {% else %}
                                                style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: #333; border: none;"
                                                {% endif %}>
                                            {% if pos.voting_enabled %}Disable Voting{% else %}Enable Voting{% endif %}
                                        </button>
                                    </div>
                                    <div class="table-responsive d-none" id="candidatesWrapperPos{{ pos.id }}">
                                        <table class="table table-sm table-hover" id="candidatesTablePos{{ pos.id }}">
                                            <thead class="d-none">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Name</th>
                                                    <th>Bio</th>
                                                    <th>Photo URL</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div class="modal" tabindex="-1" id="candidateModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="candidateModalTitle">Add Candidate</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="candidateForm">
                <input type="hidden" id="candidateId" />
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input id="candidateName" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Position</label>
                    <select id="candidatePosition" class="form-select" required>
                        <option value="">Select position</option>
                        {% for pos in positions %}
                        <option value="{{ pos.id }}">{{ pos.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Bio</label>
                    <textarea id="candidateBio" class="form-control" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Photo (file upload preferred)</label>
                    <input id="candidatePhotoFile" type="file" accept="image/*" class="form-control" />
                    <div class="form-text">Or provide a URL in the field below.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Photo URL (optional)</label>
                    <input id="candidatePhoto" class="form-control" />
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #e0f2f1, #a5d6a7); color: #333; border: none;">Cancel</button>
            <button type="button" class="btn" id="saveCandidateBtn" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #333; border: none;">Save</button>
          </div>
        </div>
      </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Upload form handler
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const fileInput = document.getElementById('voterFile');
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select a CSV file first');
            return;
        }

        const formData = new FormData(this);
        const adminToken = localStorage.getItem('adminToken') || 'admin-token';

        console.log('Upload attempt - Token:', adminToken);
        console.log('File selected:', fileInput.files[0].name);

        try {
            const response = await fetch('/admin/upload-voters', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                },
                body: formData
            });

            console.log('Upload response status:', response.status);
            const result = await response.json();
            console.log('Upload response:', result);

            if (response.ok) {
                alert(`Voters uploaded successfully!\n\n${result.message}`);
                location.reload();
            } else {
                alert('Upload failed: ' + (result.error || 'Unknown error'));

                // Show detailed error information for debugging
                if (result.error === 'Unauthorized') {
                    alert('Authentication failed. Please check your admin token.');
                } else if (result.error && result.error.includes('encoding')) {
                    alert('File encoding error. Please save your CSV file as UTF-8.');
                } else if (result.error && result.error.includes('CSV')) {
                    alert('CSV processing error. Please check your file format.');
                }
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Network error: ' + error.message);
        }
    });
});

async function generateVoterIds() {
    if (!confirm('This will generate Voter IDs for all voters without IDs. Continue?')) {
        return;
    }

    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const response = await fetch('/admin/generate-ids', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + adminToken
        }
    });

    const result = await response.json();
    if (response.ok) {
        alert(result.message);
        location.reload();
    } else {
        alert('Error: ' + result.error);
    }
}

async function exportResults() {
    try {
        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/export-results', {
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        if (response.ok) {
            // Get the CSV content
            const csvContent = await response.text();

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'slgs_obu_election_results.csv';
            document.body.appendChild(a);
            a.click();

            // Clean up
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            alert('Election results downloaded successfully!');
        } else {
            const error = await response.json();
            alert('Error exporting results: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error exporting results: ' + error.message);
    }
}

function refreshData() {
    location.reload();
}

function resetToken() {
    if (confirm('Reset admin token? You will need to enter it again.')) {
        localStorage.removeItem('adminToken');
        location.reload();
    }
}

async function clearAllData() {
    if (confirm('Clear ALL voters, votes, and candidates? This will reset the entire system and cannot be undone!')) {
        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/clear-all-data', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    }
}

async function createPositions() {
    if (confirm('Create all SLGS OBU positions if they are missing?')) {
        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/create-positions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    }
}

async function createPositionsFromBtn() {
    const debugOutput = document.getElementById('debugOutput');
    const debugText = document.getElementById('debugText');

    try {
        debugText.textContent = 'Creating positions...';
        debugOutput.style.display = 'block';

        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/create-positions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await response.json();

        if (response.ok) {
            debugText.textContent = `‚úÖ ${result.message}`;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            debugText.textContent = `‚ùå Error: ${result.error}`;
        }
    } catch (error) {
        debugText.textContent = `‚ùå Network error: ${error.message}`;
    }
}

async function checkPositionsFromBtn() {
    const debugOutput = document.getElementById('debugOutput');
    const debugText = document.getElementById('debugText');

    try {
        debugText.textContent = 'Checking positions...';
        debugOutput.style.display = 'block';

        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/check-positions', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await response.json();

        if (response.ok) {
            if (result.count > 0) {
                debugText.textContent = `‚úÖ Found ${result.count} positions: ${result.positions.map(p => p.name).join(', ')}`;
            } else {
                debugText.textContent = `‚ùå No positions found in database`;
            }
        } else {
            debugText.textContent = `‚ùå Error: ${result.error}`;
        }
    } catch (error) {
        debugText.textContent = `‚ùå Network error: ${error.message}`;
    }
}

async function fixDatabaseFromBtn() {
    const debugOutput = document.getElementById('debugOutput');
    const debugText = document.getElementById('debugText');

    if (!confirm('This will fix database schema issues by adding missing columns. Continue?')) {
        return;
    }

    try {
        debugText.textContent = 'üîß Fixing database schema...';
        debugOutput.style.display = 'block';

        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        const response = await fetch('/admin/fix-database', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await response.json();

        if (response.ok) {
            debugText.textContent = `‚úÖ ${result.message}`;
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            debugText.textContent = `‚ùå Error: ${result.error}`;
        }
    } catch (error) {
        debugText.textContent = `‚ùå Network error: ${error.message}`;
    }
}

// Store admin token (in production, use proper authentication)
if (!localStorage.getItem('adminToken')) {
    const token = prompt('Enter admin token:\n\nDefault token: admin-token\n\nThis is required to access admin functions.');
    if (token) {
        localStorage.setItem('adminToken', token);
        // Set cookie for immediate dashboard access
        document.cookie = `admin_token=${token}; path=/; max-age=86400`;
    } else {
        // Set default token if user cancels
        localStorage.setItem('adminToken', 'admin-token');
        document.cookie = 'admin_token=admin-token; path=/; max-age=86400';
        alert('Using default admin token: admin-token');
    }
    // Reload to show data with cookie
    location.reload();
}

// Add direct access link for testing
if (window.location.search.includes('debug=true')) {
    console.log('Debug mode: Adding direct access link');
    const debugDiv = document.createElement('div');
    debugDiv.className = 'alert alert-info mt-3';
    debugDiv.innerHTML = `
        <strong>Debug Mode:</strong> <a href="/admin?token=admin-token" class="btn btn-sm btn-primary">Direct Admin Access</a>
        <a href="/admin?token=admin-token&debug=true" class="btn btn-sm btn-secondary">Debug View</a>
    `;
    document.querySelector('.container').insertBefore(debugDiv, document.querySelector('.container').firstChild);
}

// Update token status display
function updateTokenStatus() {
    const token = localStorage.getItem('adminToken');
    const statusElement = document.getElementById('tokenStatus');
    if (statusElement) {
        if (token) {
            statusElement.textContent = token.substring(0, 10) + '...';
            statusElement.className = 'text-success';
        } else {
            statusElement.textContent = 'Not set';
            statusElement.className = 'text-danger';
        }
    }
}

// Update token status on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTokenStatus();
});

let POSITIONS = [];

// Voting control and polling
async function fetchVotingStatus() {
    try {
        const res = await fetch('/admin/voting-status');
        if (!res.ok) return;
        const data = await res.json();
        const badge = document.getElementById('votingStatusBadge');
        const untilText = document.getElementById('votingUntilText');
        if (data.voting_open) {
             badge.textContent = 'OPEN';
             badge.className = 'badge';
             badge.style.background = 'linear-gradient(135deg, #a5d6a7, #81c784)';
             badge.style.color = '#333';
         } else {
             badge.textContent = 'CLOSED';
             badge.className = 'badge';
             badge.style.background = 'linear-gradient(135deg, #ffcdd2, #f8bbd9)';
             badge.style.color = '#333';
         }
        if (data.voting_until) {
            untilText.textContent = 'Until: ' + new Date(data.voting_until).toLocaleString();
        } else {
            untilText.textContent = '';
        }
    } catch (e) {
        // ignore
    }
}

async function openVoting() {
    const minutes = parseInt(document.getElementById('votingMinutes').value) || 0;
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const res = await fetch('/admin/voting-control', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + adminToken
        },
        body: JSON.stringify({ action: 'open', minutes })
    });
    if (res.ok) {
        alert('Voting opened');
        fetchVotingStatus();
    } else {
        const err = await res.json();
        alert('Error: ' + (err.error || 'Unable to open voting'));
    }
}

async function closeVoting() {
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const res = await fetch('/admin/voting-control', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + adminToken
        },
        body: JSON.stringify({ action: 'close' })
    });
    if (res.ok) {
        alert('Voting closed');
        fetchVotingStatus();
    } else {
        const err = await res.json();
        alert('Error: ' + (err.error || 'Unable to close voting'));
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('openVotingBtn').addEventListener('click', openVoting);
    document.getElementById('closeVotingBtn').addEventListener('click', closeVoting);

    // Debug buttons for positions
    if (document.getElementById('createPositionsBtn')) {
        document.getElementById('createPositionsBtn').addEventListener('click', createPositionsFromBtn);
    }
    if (document.getElementById('checkPositionsBtn')) {
        document.getElementById('checkPositionsBtn').addEventListener('click', checkPositionsFromBtn);
    }
    if (document.getElementById('fixDatabaseBtn')) {
        document.getElementById('fixDatabaseBtn').addEventListener('click', fixDatabaseFromBtn);
    }

    // Initial fetch and polling every 60s
    fetchVotingStatus();
    setInterval(fetchVotingStatus, 60 * 1000);

    // Candidate management init
    initCandidateManagement().then(() => {
        // After positions are loaded, bind per-position buttons
        bindPositionButtons();
    });
});

// Candidate management JS
function _authHeaders() {
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + adminToken
    };
}

async function initCandidateManagement() {
    document.getElementById('saveCandidateBtn').addEventListener('click', saveCandidate);
    // Fetch positions (admin-only endpoint) then load candidates
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const posRes = await fetch('/admin/positions', { headers: { 'Authorization': 'Bearer ' + adminToken } });
    if (posRes.ok) {
        POSITIONS = await posRes.json();
    } else {
        // Fallback to positions rendered server-side (if available in DOM)
        POSITIONS = [];
    }
    // Load candidates for all positions
    await loadCandidates();
}

function bindPositionButtons() {
    document.querySelectorAll('.add-candidate-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const posId = parseInt(btn.dataset.pos);
            openCandidateModalForPosition(posId);
        });
    });
    document.querySelectorAll('.toggle-edit-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const posId = parseInt(btn.dataset.pos);
            toggleEditTable(posId);
        });
    });
    document.querySelectorAll('.refresh-pos-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const posId = parseInt(btn.dataset.pos);
            loadCandidates(posId);
        });
    });

    // Handle toggle voting buttons
    document.querySelectorAll('.toggle-voting-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const posId = parseInt(btn.dataset.pos);
            toggleVotingStatus(posId);
        });
    });
}

function toggleEditTable(posId) {
    const wrapper = document.getElementById(`candidatesWrapperPos${posId}`);
    const toggleBtn = document.getElementById(`toggleEditBtn${posId}`);
    const refreshBtn = document.getElementById(`refreshBtn${posId}`);
    if (!wrapper) return;
    if (wrapper.classList.contains('d-none')) {
        wrapper.classList.remove('d-none');
        if (refreshBtn) refreshBtn.classList.remove('d-none');
        loadCandidates(posId);
        if (toggleBtn) toggleBtn.textContent = 'Hide Candidates';
    } else {
        wrapper.classList.add('d-none');
        if (refreshBtn) refreshBtn.classList.add('d-none');
        if (toggleBtn) toggleBtn.textContent = 'Edit Candidates';
    }
}

async function loadCandidates(posId) {
    // If posId provided, only refresh that position table; otherwise refresh all
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const res = await fetch('/admin/candidates', { headers: { 'Authorization': 'Bearer ' + adminToken } });
    if (!res.ok) return;
    const list = await res.json();

    const positionsToUpdate = posId ? [POSITIONS.find(p => p.id === posId)] : POSITIONS;

    for (const pos of positionsToUpdate) {
        const tbody = document.querySelector(`#candidatesTablePos${pos.id} tbody`);
        if (!tbody) continue;
        tbody.innerHTML = '';
        const candidatesForPos = list.filter(c => c.position_id === pos.id);
        for (const c of candidatesForPos) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.id}</td>
                <td>${c.name}</td>
                <td>${c.bio || ''}</td>
                <td>
                    ${c.photo_url ? `<img src="${c.photo_url}" style="max-height:48px; max-width:80px; object-fit:cover;" /> <div>${c.photo_url}</div>` : ''}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCandidate(${c.id})">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCandidate(${c.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }
}

function _showModal() {
    const modalEl = document.getElementById('candidateModal');
    // Bootstrap 5 modal
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

function openCandidateModal(candidate) {
    document.getElementById('candidateForm').reset();
    document.getElementById('candidateId').value = '';
    document.getElementById('candidateModalTitle').textContent = 'Add Candidate';
    if (candidate) {
        document.getElementById('candidateId').value = candidate.id;
        document.getElementById('candidateName').value = candidate.name;
        document.getElementById('candidateBio').value = candidate.bio || '';
        document.getElementById('candidatePhoto').value = candidate.photo_url || '';
        document.getElementById('candidatePosition').value = candidate.position_id;
        document.getElementById('candidateModalTitle').textContent = 'Edit Candidate';
    }
    _showModal();
}

function openCandidateModalForPosition(posId, posName) {
    // Open modal pre-selecting the position
    openCandidateModal(null);
    document.getElementById('candidatePosition').value = posId;
    // Lookup position name if not provided
    let name = posName;
    if (!name) {
        const p = POSITIONS.find(x => x.id === posId);
        name = p ? p.name : '';
    }
    document.getElementById('candidateModalTitle').textContent = `Add Candidate to ${name}`;
}

async function editCandidate(id) {
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const res = await fetch('/admin/candidates', { headers: { 'Authorization': 'Bearer ' + adminToken } });
    if (!res.ok) return;
    const list = await res.json();
    const cand = list.find(x => x.id === id);
    if (cand) openCandidateModal(cand);
}

async function saveCandidate() {
    const id = document.getElementById('candidateId').value;
    const name = document.getElementById('candidateName').value;
    const bio = document.getElementById('candidateBio').value;
    const photoUrl = document.getElementById('candidatePhoto').value;
    const positionId = parseInt(document.getElementById('candidatePosition').value);

    const fileInput = document.getElementById('candidatePhotoFile');
    const file = fileInput && fileInput.files && fileInput.files[0];

    let res;
    if (file) {
        // Send multipart/form-data
        const formData = new FormData();
        formData.append('name', name);
        formData.append('bio', bio);
        formData.append('position_id', positionId);
        formData.append('photo_file', file);
        // Include URL as fallback
        if (photoUrl) formData.append('photo_url', photoUrl);

        const adminToken = localStorage.getItem('adminToken') || 'admin-token';
        if (id) {
            res = await fetch('/admin/candidates/' + id, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                },
                body: formData
            });
        } else {
            res = await fetch('/admin/candidates', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                },
                body: formData
            });
        }
    } else {
        const payload = { name, bio, photo_url: photoUrl, position_id: positionId };
        if (id) {
            res = await fetch('/admin/candidates/' + id, {
                method: 'PUT',
                headers: _authHeaders(),
                body: JSON.stringify(payload)
            });
        } else {
            res = await fetch('/admin/candidates', {
                method: 'POST',
                headers: _authHeaders(),
                body: JSON.stringify(payload)
            });
        }
    }
    if (res.ok) {
        alert('Saved');
        // Hide modal
        const modalEl = document.getElementById('candidateModal');
        bootstrap.Modal.getInstance(modalEl).hide();
        await loadCandidates();
    } else {
        const err = await res.json();
        alert('Error: ' + (err.error || 'Save failed'));
    }
}

async function deleteCandidate(id) {
    if (!confirm('Delete candidate #' + id + '?')) return;
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const res = await fetch('/admin/candidates/' + id, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + adminToken
        }
    });
    if (res.ok) {
        alert('Deleted');
        await loadCandidates();
    } else {
        const err = await res.json();
        alert('Error: ' + (err.error || 'Delete failed'));
    }
}

async function toggleVotingStatus(positionId) {
    const adminToken = localStorage.getItem('adminToken') || 'admin-token';
    const toggleBtn = document.getElementById('toggleVotingBtn' + positionId);

    // Disable button during request
    toggleBtn.disabled = true;
    toggleBtn.textContent = 'Updating...';

    try {
        const res = await fetch('/admin/positions/' + positionId + '/toggle-voting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + adminToken
            }
        });

        const result = await res.json();

        if (res.ok) {
            // Update button appearance and text
            if (result.voting_enabled) {
                toggleBtn.textContent = 'Disable Voting';
                toggleBtn.style.background = 'linear-gradient(135deg, #ffcdd2, #f8bbd9)';
                toggleBtn.style.color = '#333';
            } else {
                toggleBtn.textContent = 'Enable Voting';
                toggleBtn.style.background = 'linear-gradient(135deg, #a5d6a7, #81c784)';
                toggleBtn.style.color = '#333';
            }

            // Update the badge in the accordion header
            const headerBtn = document.querySelector(`[data-bs-target="#collapse${positionId}"]`);
            const badge = headerBtn.querySelector('.badge');
            if (result.voting_enabled) {
                badge.textContent = 'Voting Open';
                badge.style.background = 'linear-gradient(135deg, #a5d6a7, #81c784)';
                badge.style.color = '#333';
            } else {
                badge.textContent = 'Voting Closed';
                badge.style.background = 'linear-gradient(135deg, #ffcdd2, #f8bbd9)';
                badge.style.color = '#333';
            }

            alert(result.message);
        } else {
            alert('Error: ' + (result.error || 'Toggle failed'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // Re-enable button
        toggleBtn.disabled = false;
    }
}
</script>
{% endblock %}